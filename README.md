# Toss-CTR_Prediction
Toss-CTR_Prediction


# Toss NEXT ML Challenge [(Link)](https://dacon.io/competitions/official/236575/overview/description)
#### 본선 평가 진출

---

## 🏆 **성과 및 하이라이트**

* **목표**: 실제 광고 플랫폼에서 강건하게 동작하는 광고 클릭 예측 AI 모델 개발
* **주요 전략**: 데이터 편향/콜드스타트 극복, 공정성 및 다양성 확보
* **모델**: LGBM 단일모델 + Custom Loss + UnderSampling Bagging
* **현업 적용성**: 실시간 추론(0.003~0.05초), 신규 광고·지면에도 Robust
* [Toss Ads 광고주 가이드](https://tossads.gitbook.io/guide/ad/banner/creative) 참고

---

## 🧐 **About (문제 정의 및 배경)**

* **광고 클릭 예측**은 오프라인 정확도가 높다고 해도, 실제 서비스 환경(온라인)에서는 편향과 데이터 다양성 문제로 성능이 크게 저하될 수 있음
* 특히 **광고 추천/노출 플랫폼**의 특성상, 인기 광고나 기존 지면에만 노출·성공이 집중되고 신규 광고(콜드스타트), 다양한 지면에서는 모델 예측력이 급락
* 데이터 자체가 플랫폼 내(토스)에서 이미 편향된 분포(클릭 높은 광고 위주, 전략적 소재 선택 등)로 수집되어 있음
* 단순히 높은 오프라인 스코어(정확도, 리더보드 등)가 실제 광고주/소비자/플랫폼의 **비즈니스 성과**와 직결되지 않음

#### **문제 요약**

* **콜드스타트**: 신규 광고/지면에서 예측력 급락
* **Rich-get-richer**: 잘 노출되는 광고만 계속 성과 집중(쏠림 현상)
* **공정성/확장성**: 다양한 광고주/소재/지면의 기회 불균형, 플랫폼 성장성 저하 위험

---

## 🔥 **Approach (개조식 요약)**

### 1. **핵심 문제 인식 및 전략**

* **편향된 데이터** 환경에서 실제 서비스에 강건한 모델 구현 목표
* **콜드스타트, 데이터 쏠림 문제**를 구조적으로 해결

  * (1) 신규 광고·지면 등장시 예측력 유지
  * (2) 인기 광고만 성과 집중되는 현상 완화

### 2. **차별화된 해결책**

* **Custom 손실함수**: 데이터가 적은 신규/비인기 광고에 더 높은 학습 가중치
* **Custom Masking Validation**: 검증 데이터에서 광고/지면/소재 피처 마스킹(111111) → 신규 광고 등장 상황에 대한 일반화 능력 평가
* **UnderSampling Bagging**: 양성(클릭)과 음성(비클릭) 샘플 수 극단적 불균형(52:1) 해결, 다양한 음성 패턴까지 고르게 반영

### 3. **모델링 전략**

* **LGBM 단일 모델 채택**

  * 운영 안정성, 빠른 추론, 단순 파이프라인, 유지보수 효율성 중시
  * 앙상블이 아닌 단일 robust 모델이 실전에서 유리

### 4. **검증 및 평가 전략**

* **현실 데이터 분포(52:1) 유지 검증셋**: 실제 환경 반영
* **Downside Risk Aggregation**: 일부 케이스에서 성능 급락하는 모델 패널티 부여
* **공정성/기회 균형 평가**: 광고별 기회 불균형 완화

---

## 📝 **줄글형식 (핵심 흐름)**


광고 클릭 예측은 데이터가 **특정 광고·지면에 편향**되어 수집되는 특성이 강합니다. 이 때문에 오프라인 지표를 높였더라도, 실제 운영 환경에서 성능이 **과대평가**되기 쉽고 신규 광고·지면에서는 **콜드스타트**로 급락이 발생합니다. 본 프로젝트는 이 현실적 제약을 중심에 두고, **정확도만 높은 모델**이 아니라 **실전에서 강건한 모델**을 목표로 삼았습니다.

우선, 데이터 편향과 쏠림을 완화하기 위해 `Custom Loss`를 설계했습니다. `l_feat_14(Ads set)` 등장 빈도 기준으로 **저빈도일수록 높은 가중치**를 부여해, 인기 소재만 더 잘 예측하는 현상을 억제했습니다. 극단적인 클래스 불균형(0:1 ≈ 52:1)은 `UnderSampling Based Bagging`으로 다뤘습니다. 매 반복마다 음성(0)을 양성과 **1:1**이 되도록 언더샘플링해 다양한 음성 하위군을 학습하고, 집계 시 **결정 경계의 다양성**을 확보합니다.

검증 단계에서는 실전성과 일반화를 최우선했습니다. `Masking Validation`으로 검증셋에서 `l_feat_14 / l_feat_12 / inventory_id`를 **마스킹(111111)** 하여 Unseen 상황 대응력을 평가했고, `Real-world Validation`으로 검증셋의 **실제 분포(52:1)** 를 유지해 언더샘플링의 평가 왜곡을 방지했습니다. 또한 집계는 단순 평균이 아니라 **하위 성능을 페널티**로 반영하는 `Downside Risk` 방식을 적용해, 일부 조건에서 **취약한 모델이 채택되지 않도록** 했습니다.

모델은 실시간 서빙과 운영 안정성을 위해 **LightGBM 단일 구성**을 선택했습니다. 다양한 모델을 복잡하게 앙상블해 오프라인 지표를 극대화하는 대신, **고속 추론(0.003s/0.05s)** 과 **간결한 파이프라인**으로 실제 서비스 적용성을 높였습니다. 피처는 **베이지안 TE/불확실성(분산·엔트로피)**, **유저 최근성/활성도**, **시간 주기(sin/cos)**, **교차 통계** 등을 활용해 편향·저빈도 문제를 보정하면서도 패턴 학습력을 높였습니다.

마지막으로, 지표와 데이터 설계에 대한 피드백을 제시했습니다. AP+WLL 조합은 적절하지만, **Ads set 단위의 기회 균형**을 반영한 **가중 지표**를 함께 채택하면 비즈니스 목표(공정성/다양성)와 더 정합적인 개발·평가가 가능합니다. 테스트셋에도 **Unseen 항목 비율을 충분히 포함**해 실제 변화 환경에서의 **Robustness**를 엄밀히 평가하는 것을 권장합니다.


---

## 📖 **Dataset Info**

* **제공 데이터 주요 피처**

  * **gender, age_group**: 성별/연령
  * **inventory_id**: 지면 ID (클릭 편차 매우 큼)
  * **day_of_week, hour, seq**: 요일, 시간, 유저 서버 로그 시퀀스
  * **l_feat_***: 광고 세트 및 소재 관련 비식별 피처(l_feat_14=Ads set, l_feat_12=소재 단위)
  * **feat_e_*, feat_d_*, feat_c_*, feat_b_*, feat_a_***: 정보 영역별 피처
  * **history_a_***: 과거 인기도
  * **clicked**: 클릭 여부 (타겟)
* **특이점**

  * 모든 피처 비식별화, 피처 의미 일부만 유추 가능
  * 도메인 특성/가이드문서(광고주 가이드)를 적극적으로 참고하여 비식별 피처 의미 추론 및 피처 구성

---

## 🔧 **Feature Engineering**

### 1. **클릭 정보 피처**

* **베이지안 Target Encoding**: inventory_id별 데이터 불균형 보정, 전체 평균 클릭률을 Global Target으로 사용
* **분산, 엔트로피**: 각 지면별 예측 신뢰도/불확실성까지 추출
* **다중 범주형 조합 Encoding**: age_group, gender, hour 등 조합별 CTR 통계 반영

### 2. **유저 특성 피처**

* **seq 기반 활성도/최근 행동 피처**: 유저 행동 패턴 반영
* **유사군 그룹핑**: 나이대/성별 조합(예: 20대 초/후반 등)으로 그룹핑, 소수 데이터군 일반화 유도

### 3. **시간 정보 피처**

* **순환 특성 반영(sin/cos 변환)**: hour, day_of_week 등에 sin/cos 변환 적용, 주기성 패턴 학습 강화

---

## 🎈 **Modeling**

### **주요 모델링 구조**

* **단일 LGBM 모델**

  * 앙상블/복잡 모델 대신 단일 robust 모델 채택(실전성, 속도, 유지보수 용이성)
  * UnderSampling 기반 Bagging으로 각기 다른 음성 패턴 반영, 민감도(Recall) 개선

### **핵심 학습 전략**

* **UnderSampling Based Bagging**

  * 클릭(1) 샘플만큼 음성(0) 샘플 무작위 추출, 여러 Subset 반복 학습 후 Bagging
  * 음성 클래스 내 다양한 행동 패턴 포괄 → Robust Decision Boundary 확보

* **Custom Loss Function**

  * l_feat_14(광고세트) 등장 빈도 기준, 데이터 적은 샘플에 더 높은 가중치
  * 데이터 쏠림(rich-get-richer) 방지, 신규/롱테일 광고 예측력 확보

---

## 🧪 **학습/검증 전략**

### 1. **Masking Validation**

* 검증셋 일부 광고/소재/지면 피처값을 111111로 마스킹 → 신규 상황(콜드스타트)에서의 일반화 성능 평가

### 2. **Real-world Distribution Validation**

* 실제 서비스의 0:1(비클릭:클릭) ≒ 52:1 비율 유지, 평가 왜곡 방지

### 3. **Downside Risk Evaluation**

* 검증셋 여러 Subset별 평가, 특정 Subset에서 급락하는 모델은 패널티 부여 → Robust한 모델 선별

---

## 🚀 **현업 적용 가능성 및 기대효과**

* **확장성**: UI 개편, 신규 광고/지면/소재 등장 등 변화에도 Robust
* **유저별 광고 최적화**: 개별 유저 컨텍스트 기반 광고 랭킹/노출 전략 가능, 신규 광고/롱테일 광고에도 기회 제공
* **추론 속도**: 0.003초(유저 단일 예측) ~ 0.05초(유저별 전체 광고 랭킹)로 실시간 서빙 적합
* **운영 유연성**: Bagging 모델 개수/병렬화 등 환경에 따라 조정 가능
* **공정성/다양성**: 데이터 적은 광고/소재에도 예측력 확보, 플랫폼 생태계 균형

---

## 📝 **Feedback & 제안**

### 1. **평가지표 개선 제안**

* 전체 AP/WLL 외에도 **광고세트(l_feat_14) 단위별 가중 AP/WLL** 도입 → 공정성·다양성 평가 강화

### 2. **테스트셋 구성 제안**

* 학습에 등장하지 않은 **Unseen 광고·지면·유저** 비중 확대 → 실전 Robustness 평가에 실질적 도움

---

## 📌 **핵심 요약**

* **편향/콜드스타트** 등 광고 플랫폼 현실을 정면 돌파
* **LGBM 단일모델, Custom Loss, UnderSampling Bagging, Masking Validation** 등 도메인 특화 전략 결합
* 실전성, 예측력, 속도, 운영 유연성, 플랫폼 생태계 공정성까지 고려한 구조
* 신규/롱테일 광고까지 성과 확보, 변화에 강한 Robust AI 모델 구현






